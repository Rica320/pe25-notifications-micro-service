package pt.up.fe.pe25.task.notification.plugins.smtp;

import com.sun.istack.ByteArrayDataSource;
import io.quarkus.mailer.Attachment;
import io.quarkus.mailer.Mail;
import io.quarkus.mailer.reactive.ReactiveMailer;
import io.quarkus.qute.Template;
import io.quarkus.qute.TemplateInstance;
import io.smallrye.mutiny.Uni;
import lombok.SneakyThrows;
import org.reactivestreams.Publisher;
import pt.up.fe.pe25.task.notification.NotificationData;
import pt.up.fe.pe25.task.notification.NotificationService;
import pt.up.fe.pe25.task.notification.plugins.PluginDecorator;

import javax.enterprise.context.RequestScoped;
import javax.inject.Inject;
import javax.sql.DataSource;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;

@RequestScoped
public class MailPlugin extends PluginDecorator {

    ReactiveMailer mailer;

    Template template;

    @Inject
    public MailPlugin(NotificationService notificationService, ReactiveMailer mailer, Template template) {
        super(notificationService);
        this.mailer = mailer;
        this.template = template;
    }

    public MailPlugin() {
        super(null);
    }

    @SneakyThrows
    private Attachment getAttachment(String base64) {
        byte[] fileData = Base64.getDecoder().decode(base64);

        File tempFile = File.createTempFile("attachment", ".pdf");
        try (OutputStream os = new FileOutputStream(tempFile)){
            os.write(fileData);
        }

        return new Attachment("attachment.pdf", tempFile, "application/pdf");
    }

    private void addAttachments(List<Attachment> attachments, List<String> base64s) {
        for (String base64 : base64s) {
            System.out.println(base64);
            attachments.add(getAttachment(base64));
        }
    }
/*"attachments": ["data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4NCjwhLS0gRG8gbm90IGVkaXQgdGhpcyBmaWxlIHdpdGggZWRpdG9ycyBvdGhlciB0aGFuIGRpYWdyYW1zLm5ldCAtLT4NCjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+DQo8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHZlcnNpb249IjEuMSIgd2lkdGg9Ijg1MXB4IiBoZWlnaHQ9IjQ0MHB4IiB2aWV3Qm94PSItMC41IC0wLjUgODUxIDQ0MCIgY29udGVudD0iJmx0O214ZmlsZSBob3N0PSZxdW90O2FwcC5kaWFncmFtcy5uZXQmcXVvdDsgbW9kaWZpZWQ9JnF1b3Q7MjAyMy0wMy0wMlQxNDoyOTozNS4xMTFaJnF1b3Q7IGFnZW50PSZxdW90OzUuMCAoV2luZG93cykmcXVvdDsgZXRhZz0mcXVvdDtHb0haUlREOHhkSEFWUXBPZUFLTiZxdW90OyB2ZXJzaW9uPSZxdW90OzIwLjQuMCZxdW90OyB0eXBlPSZxdW90O2RldmljZSZxdW90OyZndDsmbHQ7ZGlhZ3JhbSBpZD0mcXVvdDtDNVJCczQzb0RhLUtkelplTnR1eSZxdW90OyBuYW1lPSZxdW90O1BhZ2UtMSZxdW90OyZndDs3VnBiYzlNNkVQNDFtWUdITXI3azFzY2tiZUhRQW9VQ2hmTnlSckVWVzQxaUdWbHVFbjQ5SzF1T0wxSXViUlBhQTUzSnROWjZKVm43ZmRwZHI5VnlSN1BGYTQ3aThCM3pNVzA1bHI5b3VTY3R4N0g3dGdYL3BHU1pTenFkYmk0SU9QR1ZVaW00SWoreEVxcCtRVXA4bk5RVUJXTlVrTGd1OUZnVVlVL1VaSWh6TnErclRSaXR6eHFqQUd1Q0t3OVJYWHBOZkJIbTByN1RLK1Z2TUFuQ1ltYTdlNXpmbWFGQ1dhMGtDWkhQNWhXUmU5cHlSNXd4a1YvTkZpTk1wZkVLdTF6L3M3eW1GOVB1NjdjZmt4L295L0Q4OC91dlIvbGdaM2Zwc2xvQ3g1RzQ5OUM5TnovK0N6Lzg2OGZ4emJ2ejVNdjc4NkYxWGd5ZGlHVmhMK3lEK1ZTVGNSR3lnRVdJbnBiU0lXZHA1R001cWdXdFV1ZUNzUmlFTmdodnNCQkx4UVdVQ2dhaVVNeW91b3NYUkh5VDNWOTFWT3U3R2t4ZW55eXFqV1hSaUFSZlZqcko1dmRpUE5rb3UyV3RzcDgva0N5QzVwZ3liNXFMemdpbFNzRkhTWmd0SmgrcFlMRHRRak0zanJSSWcwdGJnQ2lzeWxMdXFhNC9wNU96TjEvYk45L2l5N09QYyt2MVlQejJTQUZtQ2NRRExEYWdWTElOdGlsbU13d3JoSDRjVXlUSWJmM2hrTm92d1VxdjVBUmNLRnFZS2JMcElXOFJUZFZNbHpRTlNIU0NQY2FSWUZ5alVESW5NNG9peVpVSmkwVEJKbGpDRUZFU1JIRHRnUUV4QjhFdDVvTEFiaDJvRzBKeWFPaUZoUG9YYU1sU2FaWkVJRzlhdElZaDQrUW5ESXNLT3NGdExoUnNUcmVtY1NWN0txQTVUa0Ruc3NET1hva3VVQ0tVanNjb1JYRkN4dGtEUzVVWllFT2lJUk9DellxQmF2eGZlWVdzSVRpYnJ2eU12YUxRcm95UjFzQ0xDcDQ2Nk9ydXlyOHF0MndYWG1wZU9qbkhWYkt3NXVDYzlVUlIwMzBDUjR5aUFJeFF6dWMyNW12cjg5bGR3M3hPdHo0ZG9nQjhoQVFlU2pNbUdqMVhTNzAvWTIyTnNVZlFqSmdnRTZDYUlDeTZ3dnlXeUswNWdCdnZEVGVhbEFaVVJJVytGRS9FV3ZJbU1mSklGRnhrT2lmdFV2SkpXVVdLR1BTZDBJdzRJZkY5SEdYRUVraWduSHVTVFRFamtjak0xaG5DRDR3N2t0NnZBdzgwZ3JaZHR1RW4xYmtZc1FnNGlFaEdOZ3pFbm1OSmJnTU5OKzcxN1RSYzF0SGR4cm9tQy9ibW5kb2ExaHAybEdTdXFCS0E5RzI2QmRnWlFKVEZQb1hrNXl6U0hka2EycTZPdG10QWxxSXhwcGNzSVpKeklPTzViZ1B4eHdLMTQrd0dhdjlBbUhZTW1NSmlyVWJjZVJHdDNiOHZXeU9uTmJEdThQZDV3Ky9HamU2T1lXWWZHOTZZQzYwalIrYmVseStxWHY0RWpLdFRSRXBmL3FGNGF6anVTb0cxZVBjZjI4RjNOYnl2UXlTU1FSem43bURYN05ONnpqNzNsMzBlMTVOQmQxZXYwTGZ1azN2YWpkelQ3VC9kM1BQNE9SL1o1bkM2TzdQdGprbm1vZklSVzMraHVGL01nWFc0aTBGbUtmUGxIeG1VOWs4SXQvM0lRYWw0aDk2MHpjMlZwNks4WkdtRnFDMnV2TzczcTFVNlRNZHNYaTNRWlFLNFVSRGx6b0ZnYStGSzJiVmF1TnFVWGpZcWFEcXVKa2UrYzNWTERYY3BlVnNwV0ZqMW9PRllibjJJZkpHcVY3VnVldGVCY2l0b0ErMnRtdUZxWER1ZElVS2YwNTlIUzMvYWRudUgvS2RyaUZBYkhOTDYvTWR0NzVELzlKNUcvbVByQlJsWmZFTUN5QkRPTWh4a2NEeGhYcHExL3RLUXQ5clVEMHVDREJRN1hNd3p2WGsvcDdZUGhOVllhek41am9lamFpeW5tTjVYbmxQYlE5WmJjbzdjcmNEMlcvZTVYbkg1cTNMYllnOC82ZVMyOGZYUDdkMHp1WFViQXptOXhyUHNMN2xkLzJXN3pqVlpqeDhTbWFGT0VBQUZ6YUgwSkZUdXVqR0hxeURmZjBwU0NJeGY4WElkZUxKeDJhOUI1VXFzMm1sUHIrZlcrbSsxM1U3TnlMWWhmWE1NNlZ0blE3WHNRVTdmc0tGLzM2bVA0am83ODdFNkFiTGwxTWZxbUVlbDE0WlRIODFESFp1UGdHVHZNSVdLVDlDTVJmN25rRVRGcllycVRUcUwxUW83TGUyOFNQVmx5TzYzRG4rQXBEaFE5VlFPa0Jnbjd6K1liUTJyUCtUSVVXdk5nU1BwbVN2azZ4YTh2TVNjZ0JuazYzTHpISkpsSGRkWkNkNTBDeSt6Vm5QSUdsbHJYSXhZbGs0M1NWZ2h0Tkl3OExsS3c4TWRheklDM3RzeGdOcHIzT2J2b1dYUGtPWTBZa3FTeHBpYm9zaXJOZW14L2wwUk1wOFlaMEFKQ2RROEpBSmZ4U2l6MzV5anVFN1RNZkttUWNiOUQ2bklYNll5dVkvNDlJUE1lY1V5cDE3bmdPRUtjR2xrRisyT0hyQk0zMXRzNjFBUnl6WWtDazIwOG9KWTBwS2hWSWNzWWJMZWdMVmVhOVRCaGtnK0ZFMWwrcy9sbXZpUEZNQVRxYnp4LzBlNTAyMWtmcWFzcEw4bmtLRlpucFBOYzhmeXRMRjcrZ3M9Jmx0Oy9kaWFncmFtJmd0OyZsdDsvbXhmaWxlJmd0OyI+PGRlZnM+PGNsaXBQYXRoIGlkPSJteC1jbGlwLTMyNC0xNDEtMjIyLTI2LTAiPjxyZWN0IHg9IjMyNCIgeT0iMTQxIiB3aWR0aD0iMjIyIiBoZWlnaHQ9IjI2Ii8+PC9jbGlwUGF0aD48Y2xpcFBhdGggaWQ9Im14LWNsaXAtMzI0LTE3NS0yMjItMjYtMCI+PHJlY3QgeD0iMzI0IiB5PSIxNzUiIHdpZHRoPSIyMjIiIGhlaWdodD0iMjYiLz48L2NsaXBQYXRoPjxjbGlwUGF0aCBpZD0ibXgtY2xpcC0zMjQtMjAxLTIyMi0yNi0wIj48cmVjdCB4PSIzMjQiIHk9IjIwMSIgd2lkdGg9IjIyMiIgaGVpZ2h0PSIyNiIvPjwvY2xpcFBhdGg+PGNsaXBQYXRoIGlkPSJteC1jbGlwLTIwNC0zODktMjIyLTI2LTAiPjxyZWN0IHg9IjIwNCIgeT0iMzg5IiB3aWR0aD0iMjIyIiBoZWlnaHQ9IjI2Ii8+PC9jbGlwUGF0aD48Y2xpcFBhdGggaWQ9Im14LWNsaXAtNTI4LTM4MS0yMjgtMjYtMCI+PHJlY3QgeD0iNTI4IiB5PSIzODEiIHdpZHRoPSIyMjgiIGhlaWdodD0iMjYiLz48L2NsaXBQYXRoPjxjbGlwUGF0aCBpZD0ibXgtY2xpcC01MjgtNDE1LTIyOC0yNi0wIj48cmVjdCB4PSI1MjgiIHk9IjQxNSIgd2lkdGg9IjIyOCIgaGVpZ2h0PSIyNiIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnPjxwYXRoIGQ9Ik0gNDM1IDExMCBMIDQzNSA2NS4xMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ic3Ryb2tlIi8+PHBhdGggZD0iTSA0MzUgNTEuMTIgTCA0NDIgNjUuMTIgTCA0MjggNjUuMTIgWiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxwYXRoIGQ9Ik0gMzIwIDEzNiBMIDMyMCAxMTAgTCA1NTAgMTEwIEwgNTUwIDEzNiIgZmlsbD0icmdiKDI1NSwgMjU1LCAyNTUpIiBzdHJva2U9InJnYigwLCAwLCAwKSIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0iYWxsIi8+PHBhdGggZD0iTSAzMjAgMTM2IEwgMzIwIDIyMiBMIDU1MCAyMjIgTCA1NTAgMTM2IiBmaWxsPSJub25lIiBzdHJva2U9InJnYigwLCAwLCAwKSIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMzIwIDEzNiBMIDU1MCAxMzYiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXN0eWxlPSJpdGFsaWMiIHBvaW50ZXItZXZlbnRzPSJub25lIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEycHgiPjx0ZXh0IHg9IjQzNC41IiB5PSIxMjcuNSI+UGx1Z2luRGVjb3JhdG9yPC90ZXh0PjwvZz48ZyBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIHBvaW50ZXItZXZlbnRzPSJub25lIiBjbGlwLXBhdGg9InVybCgjbXgtY2xpcC0zMjQtMTQxLTIyMi0yNi0wKSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSIzMjUuNSIgeT0iMTUzLjUiPi0gbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZTwvdGV4dD48L2c+PHBhdGggZD0iTSAzMjAgMTY2IEwgNTUwIDE2NiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIHBvaW50ZXItZXZlbnRzPSJub25lIiBjbGlwLXBhdGg9InVybCgjbXgtY2xpcC0zMjQtMTc1LTIyMi0yNi0wKSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSIzMjUuNSIgeT0iMTg3LjUiPisgUGx1Z2luRGVjb3JhdG9yKG46IE5vdGlmaWNhdGlvblNlcnZpY2UpwqDCoMKgwqDCoMKgwqDCoDwvdGV4dD48L2c+PGcgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgY2xpcC1wYXRoPSJ1cmwoI214LWNsaXAtMzI0LTIwMS0yMjItMjYtMCkiIGZvbnQtc2l6ZT0iMTJweCI+PHRleHQgeD0iMzI1LjUiIHk9IjIxMy41Ij4rIG5vdGlmeShub3RpZmljYXRpb25EYXRhOiBOb3RpZmljYXRpb25EYXRhKTwvdGV4dD48L2c+PHBhdGggZD0iTSAyMDAgMzc2IEwgMjAwIDM1MCBMIDQzMCAzNTAgTCA0MzAgMzc2IiBmaWxsPSJyZ2IoMjU1LCAyNTUsIDI1NSkiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHBhdGggZD0iTSAyMDAgMzc2IEwgMjAwIDQzMCBMIDQzMCA0MzAgTCA0MzAgMzc2IiBmaWxsPSJub25lIiBzdHJva2U9InJnYigwLCAwLCAwKSIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMjAwIDM3NiBMIDQzMCAzNzYiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSIzMTQuNSIgeT0iMzY3LjUiPldoYXRzQXBwUGx1Z2luPC90ZXh0PjwvZz48cGF0aCBkPSJNIDIwMCAzODAgTCA0MzAgMzgwIiBmaWxsPSJub25lIiBzdHJva2U9InJnYigwLCAwLCAwKSIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxnIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgcG9pbnRlci1ldmVudHM9Im5vbmUiIGNsaXAtcGF0aD0idXJsKCNteC1jbGlwLTIwNC0zODktMjIyLTI2LTApIiBmb250LXNpemU9IjEycHgiPjx0ZXh0IHg9IjIwNS41IiB5PSI0MDEuNSI+KyBub3RpZnkobm90aWZpY2F0aW9uRGF0YTogTm90aWZpY2F0aW9uRGF0YSk8L3RleHQ+PC9nPjxwYXRoIGQ9Ik0gMzE1IDM1MCBMIDMxNSAyODYgTCA0MzUgMjg2IEwgNDM1IDIzNC4xMiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDQzNSAyMjMuMTIgTCA0NDAuNSAyMzQuMTIgTCA0MjkuNSAyMzQuMTIgWiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDUyNCAzNzYgTCA1MjQgMzUwIEwgNzYwIDM1MCBMIDc2MCAzNzYiIGZpbGw9InJnYigyNTUsIDI1NSwgMjU1KSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDUyNCAzNzYgTCA1MjQgNDM2IEwgNzYwIDQzNiBMIDc2MCAzNzYiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHBhdGggZD0iTSA1MjQgMzc2IEwgNzYwIDM3NiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIHBvaW50ZXItZXZlbnRzPSJub25lIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEycHgiPjx0ZXh0IHg9IjY0MS41IiB5PSIzNjcuNSI+RW1haWxQbHVnaW48L3RleHQ+PC9nPjxnIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgcG9pbnRlci1ldmVudHM9Im5vbmUiIGNsaXAtcGF0aD0idXJsKCNteC1jbGlwLTUyOC0zODEtMjI4LTI2LTApIiBmb250LXNpemU9IjEycHgiPjx0ZXh0IHg9IjUyOS41IiB5PSIzOTMuNSI+LSBhdHRhY2htZW50OiBEb2N1bWVudDwvdGV4dD48L2c+PHBhdGggZD0iTSA1MjQgNDA2IEwgNzYwIDQwNiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIHBvaW50ZXItZXZlbnRzPSJub25lIiBjbGlwLXBhdGg9InVybCgjbXgtY2xpcC01MjgtNDE1LTIyOC0yNi0wKSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSI1MjkuNSIgeT0iNDI3LjUiPisgbm90aWZ5KG5vdGlmaWNhdGlvbkRhdGE6IE5vdGlmaWNhdGlvbkRhdGEpPC90ZXh0PjwvZz48cGF0aCBkPSJNIDY0MiAzNTAgTCA2NDIgMjg2IEwgNDM1IDI4NiBMIDQzNSAyMzQuMTIiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHBhdGggZD0iTSA0MzUgMjIzLjEyIEwgNDQwLjUgMjM0LjEyIEwgNDI5LjUgMjM0LjEyIFoiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PHJlY3QgeD0iMzc1IiB5PSIwIiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjUwIiBmaWxsPSJyZ2IoMjU1LCAyNTUsIDI1NSkiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0wLjUgLTAuNSkiPjxzd2l0Y2g+PGZvcmVpZ25PYmplY3Qgc3R5bGU9Im92ZXJmbG93OiB2aXNpYmxlOyB0ZXh0LWFsaWduOiBsZWZ0OyIgcG9pbnRlci1ldmVudHM9Im5vbmUiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSI+PGRpdiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94aHRtbCIgc3R5bGU9ImRpc3BsYXk6IGZsZXg7IGFsaWduLWl0ZW1zOiB1bnNhZmUgY2VudGVyOyBqdXN0aWZ5LWNvbnRlbnQ6IHVuc2FmZSBjZW50ZXI7IHdpZHRoOiAxcHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjVweDsgbWFyZ2luLWxlZnQ6IDQzNXB4OyI+PGRpdiBzdHlsZT0iYm94LXNpemluZzogYm9yZGVyLWJveDsgZm9udC1zaXplOiAwcHg7IHRleHQtYWxpZ246IGNlbnRlcjsiIGRhdGEtZHJhd2lvLWNvbG9ycz0iY29sb3I6IHJnYigwLCAwLCAwKTsgIj48ZGl2IHN0eWxlPSJkaXNwbGF5OiBpbmxpbmUtYmxvY2s7IGZvbnQtc2l6ZTogMTJweDsgZm9udC1mYW1pbHk6IEhlbHZldGljYTsgY29sb3I6IHJnYigwLCAwLCAwKTsgbGluZS1oZWlnaHQ6IDEuMjsgcG9pbnRlci1ldmVudHM6IG5vbmU7IHdoaXRlLXNwYWNlOiBub3dyYXA7Ij7Cq2ludGVyZmFjZcK7PGJyIC8+PGI+Tm90aWZpY2F0aW9uU2VydmljZTwvYj48L2Rpdj48L2Rpdj48L2Rpdj48L2ZvcmVpZ25PYmplY3Q+PHRleHQgeD0iNDM1IiB5PSIyOSIgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBmb250LXNpemU9IjEycHgiIHRleHQtYW5jaG9yPSJtaWRkbGUiPsKraW50ZXJmYWNlwrsuLi48L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gNTY5Ljk5IDE0OSBMIDU4MCAxNDkgTCA1ODAgMjUgTCA1MTAuMTIgMjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiKDAsIDAsIDApIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS1kYXNoYXJyYXk9IjMgMyIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDU1MC45OSAxNDkgTCA1NjAuNDkgMTQzLjQxIEwgNTY5Ljk5IDE0OSBMIDU2MC40OSAxNTQuNTkgWiIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDQ5Ni4xMiAyNSBMIDUxMC4xMiAxOCBMIDUxMC4xMiAzMiBaIiBmaWxsPSJub25lIiBzdHJva2U9InJnYigwLCAwLCAwKSIgc3Ryb2tlLW1pdGVybGltaXQ9IjEwIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMTYwIDQwMCBMIDE4MCA0MDAgTCAxODAgMzkwIEwgMjAyLjA3IDM5MC4wMSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgc3Ryb2tlLWRhc2hhcnJheT0iMyAzIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIvPjxwYXRoIGQ9Ik0gMCAzMzUgTCAxMzAgMzM1IEwgMTYwIDM2NSBMIDE2MCA0MzUgTCAwIDQzNSBMIDAgMzM1IFoiIGZpbGw9InJnYigyNTUsIDI1NSwgMjU1KSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDEzMCAzMzUgTCAxMzAgMzY1IEwgMTYwIDM2NSBaIiBmaWxsLW9wYWNpdHk9IjAuMDUiIGZpbGw9IiMwMDAwMDAiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDEzMCAzMzUgTCAxMzAgMzY1IEwgMTYwIDM2NSIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMTU4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMzg1cHg7IG1hcmdpbi1sZWZ0OiAxcHg7Ij48ZGl2IHN0eWxlPSJib3gtc2l6aW5nOiBib3JkZXItYm94OyBmb250LXNpemU6IDBweDsgdGV4dC1hbGlnbjogY2VudGVyOyIgZGF0YS1kcmF3aW8tY29sb3JzPSJjb2xvcjogcmdiKDAsIDAsIDApOyAiPjxkaXYgc3R5bGU9ImRpc3BsYXk6IGlubGluZS1ibG9jazsgZm9udC1zaXplOiAxMnB4OyBmb250LWZhbWlseTogSGVsdmV0aWNhOyBjb2xvcjogcmdiKDAsIDAsIDApOyBsaW5lLWhlaWdodDogMS4yOyBwb2ludGVyLWV2ZW50czogbm9uZTsgd2hpdGUtc3BhY2U6IG5vcm1hbDsgb3ZlcmZsb3ctd3JhcDogbm9ybWFsOyI+PGI+c3VwZXI8L2I+Lm5vdGlmeShub3RpZmljYXRpb25EYXRhKTwvZGl2PjwvZGl2PjwvZGl2PjwvZm9yZWlnbk9iamVjdD48dGV4dCB4PSI4MCIgeT0iMzg5IiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+c3VwZXIubm90aWZ5KG5vdGlmaWNhdGlvbkQuLi48L3RleHQ+PC9zd2l0Y2g+PC9nPjxwYXRoIGQ9Ik0gNjcwIDIwMCBMIDgyMCAyMDAgTCA4NTAgMjMwIEwgODUwIDMwMCBMIDY3MCAzMDAgTCA2NzAgMjAwIFoiIGZpbGw9InJnYigyNTUsIDI1NSwgMjU1KSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDgyMCAyMDAgTCA4MjAgMjMwIEwgODUwIDIzMCBaIiBmaWxsLW9wYWNpdHk9IjAuMDUiIGZpbGw9IiMwMDAwMDAiIHN0cm9rZT0ibm9uZSIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48cGF0aCBkPSJNIDgyMCAyMDAgTCA4MjAgMjMwIEwgODUwIDIzMCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9Im5vbmUiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMC41IC0wLjUpIj48c3dpdGNoPjxmb3JlaWduT2JqZWN0IHN0eWxlPSJvdmVyZmxvdzogdmlzaWJsZTsgdGV4dC1hbGlnbjogbGVmdDsiIHBvaW50ZXItZXZlbnRzPSJub25lIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiByZXF1aXJlZEZlYXR1cmVzPSJodHRwOi8vd3d3LnczLm9yZy9UUi9TVkcxMS9mZWF0dXJlI0V4dGVuc2liaWxpdHkiPjxkaXYgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiIHN0eWxlPSJkaXNwbGF5OiBmbGV4OyBhbGlnbi1pdGVtczogdW5zYWZlIGNlbnRlcjsganVzdGlmeS1jb250ZW50OiB1bnNhZmUgY2VudGVyOyB3aWR0aDogMTc4cHg7IGhlaWdodDogMXB4OyBwYWRkaW5nLXRvcDogMjUwcHg7IG1hcmdpbi1sZWZ0OiA2NzFweDsiPjxkaXYgc3R5bGU9ImJveC1zaXppbmc6IGJvcmRlci1ib3g7IGZvbnQtc2l6ZTogMHB4OyB0ZXh0LWFsaWduOiBjZW50ZXI7IiBkYXRhLWRyYXdpby1jb2xvcnM9ImNvbG9yOiByZ2IoMCwgMCwgMCk7ICI+PGRpdiBzdHlsZT0iZGlzcGxheTogaW5saW5lLWJsb2NrOyBmb250LXNpemU6IDEycHg7IGZvbnQtZmFtaWx5OiBIZWx2ZXRpY2E7IGNvbG9yOiByZ2IoMCwgMCwgMCk7IGxpbmUtaGVpZ2h0OiAxLjI7IHBvaW50ZXItZXZlbnRzOiBub25lOyB3aGl0ZS1zcGFjZTogbm9ybWFsOyBvdmVyZmxvdy13cmFwOiBub3JtYWw7Ij48Yj5QbHVnaW5zIDwvYj5zb21lbnRlPGI+IDwvYj5wYXJhIGlsdXN0cmFyIGFycXVpdGV0dXJhPC9kaXY+PC9kaXY+PC9kaXY+PC9mb3JlaWduT2JqZWN0Pjx0ZXh0IHg9Ijc2MCIgeT0iMjU0IiBmaWxsPSJyZ2IoMCwgMCwgMCkiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTJweCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UGx1Z2lucyBzb21lbnRlIHBhcmEgaWx1c3RyYXIuLi48L3RleHQ+PC9zd2l0Y2g+PC9nPjwvZz48c3dpdGNoPjxnIHJlcXVpcmVkRmVhdHVyZXM9Imh0dHA6Ly93d3cudzMub3JnL1RSL1NWRzExL2ZlYXR1cmUjRXh0ZW5zaWJpbGl0eSIvPjxhIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAsLTUpIiB4bGluazpocmVmPSJodHRwczovL3d3dy5kaWFncmFtcy5uZXQvZG9jL2ZhcS9zdmctZXhwb3J0LXRleHQtcHJvYmxlbXMiIHRhcmdldD0iX2JsYW5rIj48dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjEwcHgiIHg9IjUwJSIgeT0iMTAwJSI+VGV4dCBpcyBub3QgU1ZHIC0gY2Fubm90IGRpc3BsYXk8L3RleHQ+PC9hPjwvc3dpdGNoPjwvc3ZnPg=="],*/
    @Override
    public boolean notify(NotificationData notificationData) {
        if (notificationService != null)
            super.notify(notificationData);

        List<Attachment> attachments = new ArrayList<>();
        System.out.println(notificationData.getAttachments());
        if (notificationData.getAttachments() != null)
            addAttachments(attachments, notificationData.getAttachments());


        boolean valid = true;
        for (String email : notificationData.getReceiverEmails()) {
            if (!email.matches("^[A-Za-z0-9+_.-]+@(.+)$")) {
                valid = false;
                continue;
            }
            try {
                TemplateInstance templateInstance = template.data("message", notificationData.getMessage());

                Mail mail = Mail.withHtml(email, notificationData.getSubject(), templateInstance.render());

                if (!attachments.isEmpty())
                    mail.setAttachments(attachments);

                Uni<Void> x = mailer.send(mail);

                x.subscribe().with(
                        item -> System.out.println("Sent"),
                        failure -> System.out.println("Failed to send email: " + failure.getMessage())
                );
            } catch (Exception e) {
                valid = false; // TODO: dps temos de arranjar maneira de devolver isto ao resource para que ele diga quais estão indisponíveis
            }
        }

        return valid;
    }
}
